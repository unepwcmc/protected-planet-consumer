module Parcc::Downloads::Generators::Vulnerability
  BASE_PATH = Rails.root.join('tmp/downloads/')

  HEADERS = [
    'Name',
    'Taxonomic Order',
    'Taxonomic Class',
    'IUCN Category',
    'Exposure by 2010-2039',
    'Exposure by 2040-2069',
    'Overlap Percentage',
    'Sensitivity Traits',
    'Adaptability Traits',
  ]

  def self.generate protected_area
    filename = "#{protected_area.wdpa_id}_vulnerability.csv"
    full_path = BASE_PATH.join(filename)

    CSV.open(full_path, 'wb') do |csv|
      csv << HEADERS

      protected_area.species_protected_areas.each { |species_protected_area|
        csv << collect_values(species_protected_area)
      }
    end

    full_path
  end

  def self.collect_values species_protected_area
    species = species_protected_area.species
    [
      species.name,
      species.taxonomic_order.name,
      species.taxonomic_class.name,
      species.iucn_cat,
      species.exposure_2025.present?,
      species.exposure_2055.present?,
      species_protected_area.overlap_percentage,
      species.sensitivity,
      species.adaptability
    ]
  end
end
